{% extends "base.html" %}

{% block title %}Hand Gesture Trigger - Activity Launch App{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0">
        <div class="col-12">
            <div class="position-relative" style="height: 100vh; background: black; overflow: hidden;">
                <!-- Fullscreen video feed -->
                <div class="position-absolute top-0 start-0 w-100 h-100">
                    <img id="cam" src="{{ url_for('video_feed') }}" alt="Camera Feed" 
                         class="w-100 h-100" style="object-fit: cover;">
                </div>
                
                <!-- Overlay controls -->
                <div class="position-absolute top-0 start-0 p-3" style="z-index: 10;">
                    <div class="d-flex align-items-center mb-2">
                        <span class="status-indicator me-2" id="gesture-indicator"></span>
                        <span id="gesture-text" class="text-white">Waiting for hand detection...</span>
                    </div>
                    
                    <!-- Camera status notice -->
                    <div class="alert alert-info mt-2" id="camera-notice" style="max-width: 400px;">
                        <i class="fas fa-camera me-2"></i>
                        <strong>Hand Gesture Detection</strong><br>
                        Place your hand over the hand sketch in the center to trigger the countdown.
                        <br><small>Make sure your camera is working and well-lit.</small>
                    </div>
                </div>
                
                <!-- Countdown display at the top -->
                <div id="countdown-display" class="text-center" style="display: none; position: absolute; top: 5%; left: 50%; transform: translateX(-50%); z-index: 20;">
                    <div class="text-white fs-1 fw-bold" id="countdown-text" style="font-size: 6rem; text-shadow: 3px 3px 6px rgba(0,0,0,0.9);">3</div>
                    <div class="text-white fs-3" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">Hold steady...</div>
                </div>
                
                <!-- Back button -->
                <div class="position-absolute top-0 end-0 p-3" style="z-index: 10;">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let pollInterval;

function triggerLaunch() {
    fetch('{{ url_for("hand_trigger") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '{{ url_for("launch") }}';
        } else {
            throw new Error('Trigger failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to trigger launch. Please try again.');
    });
}

function showCountdown(seconds) {
    const countdownDisplay = document.getElementById('countdown-display');
    const countdownText = document.getElementById('countdown-text');
    countdownDisplay.style.display = 'block';
    const count = Math.ceil(seconds);
    countdownText.textContent = count;
    // Add visual feedback for countdown
    if (count === 3) {
        countdownText.style.color = '#ff6b6b'; // Red
    } else if (count === 2) {
        countdownText.style.color = '#ffa726'; // Orange
    } else if (count === 1) {
        countdownText.style.color = '#66bb6a'; // Green
    }
    // Do NOT trigger launch here; only show countdown
}

function hideCountdown() {
    const countdownDisplay = document.getElementById('countdown-display');
    countdownDisplay.style.display = 'none';
}

// Poll hand detection status and auto-trigger
function startPolling() {
    pollInterval = setInterval(() => {
        fetch('{{ url_for("hand_status") }}')
            .then(r => r.json())
            .then(data => {
                const indicator = document.getElementById('gesture-indicator');
                const text = document.getElementById('gesture-text');
                
                if (data.detected) {
                    indicator.className = 'status-indicator status-active';
                    
                    if (data.inside) {
                        if (data.countdown_remaining > 0) {
                            text.textContent = `Hand detected! Hold steady...`;
                            showCountdown(data.countdown_remaining);
                        } else if (data.launch) {
                            text.textContent = 'Launching activity...';
                            hideCountdown();
                            clearInterval(pollInterval);
                            setTimeout(() => triggerLaunch(), 100); // Launch only if backend says so
                        } else {
                            text.textContent = 'Move hand into the target area';
                            hideCountdown();
                        }
                    } else {
                        text.textContent = 'Move hand into the target area';
                        hideCountdown();
                    }
                } else {
                    indicator.className = 'status-indicator status-inactive';
                    text.textContent = 'Waiting for hand...';
                    hideCountdown();
                }
            })
            .catch(() => {});
    }, 100); // Faster polling for smoother countdown
}

document.addEventListener('DOMContentLoaded', startPolling);

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (pollInterval) clearInterval(pollInterval);
    fetch('{{ url_for("cleanup") }}');
});
</script>
{% endblock %}