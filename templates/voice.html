{% extends "base.html" %}

{% block title %}Voice Command Trigger - Activity Launch App{% endblock %}

{% block extra_css %}
<style>
    /* Improve readability and ensure long text is fully visible */
    #status-text, #instruction-text { color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,.6); }
    .transcript-box {
        background: rgba(0,0,0,.55);
        color: #e9f0ff;
        border: 1px solid rgba(255,255,255,.2);
        border-radius: 8px;
        padding: 12px;
        max-height: 40vh;
        overflow: auto;
        white-space: pre-wrap;   /* keep newlines */
        word-break: break-word;  /* wrap long words/links */
        font-size: 1.1rem;
    }
    .transcript-title { color: #cfe8ff; font-weight: 600; margin-bottom: 6px; }
    .card h6.card-title { color: #e8f3ff; }
    .status-indicator { vertical-align: middle; }
    .voice-grid { row-gap: 1rem; }
    .voice-grid .card { background: rgba(0,0,0,.35); border-color: rgba(255,255,255,.15); }
    .btn-primary { box-shadow: 0 6px 18px rgba(0,123,255,.35); }
    .btn-primary:disabled { opacity: .8; }
    .micro-big { font-size: 4.5rem; }
    @media (max-width: 576px) {
        .micro-big { font-size: 3.5rem; }
    }
    .voice-wrapper { color: #e9f0ff; }
    .voice-wrapper .text-muted { color: rgba(233,240,255,.8) !important; }
    .history-scroll { max-height: 30vh; overflow: auto; }
    .history-item { padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,.18); }
    .history-item:last-child { border-bottom: none; }
</style>
{% endblock %}

{% block extra_css %}
<script>
    // Ensure the class is set before DOMContentLoaded for all devices
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('require-permission');
    });
</script>
{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                <h2 class="mb-0">
                    <i class="fas fa-microphone me-2"></i>Voice Command Detection
                </h2>
            </div>
            <div class="card-body p-4 text-center voice-wrapper">
                <div class="mb-4">
                    <div id="microphone-icon" class="mb-3">
                        <i class="fas fa-microphone micro-big text-primary"></i>
                    </div>
                    
                    <h4 id="status-text">Ready to Listen</h4>
                    <p class="text-muted" id="instruction-text" style="margin-bottom: 0.75rem;">
                        Click the button below or say a command to trigger the launch
                    </p>
                    <div class="transcript-box mt-2" id="transcript">
                        <div class="transcript-title">Transcript</div>
                        <div id="transcript-content">— Speak to see captured text here —</div>
                    </div>
                </div>
                
                <div class="mb-4 d-flex flex-wrap gap-2 justify-content-center">
                    <button class="btn btn-primary btn-lg" id="listen-btn" onclick="startListening()">
                        <i class="fas fa-microphone me-2"></i>Start Listening
                    </button>
                    <button class="btn btn-success btn-lg" id="launch-now-btn" onclick="launchNow()">
                        <i class="fas fa-rocket me-2"></i>Launch Now
                    </button>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Voice Commands:</strong> Say "launch", "open", "start", or "go" to trigger the launch.
                </div>
                
                <div class="row mt-4 voice-grid">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-volume-up me-2"></i>Audio Status
                                </h6>
                                <div id="audio-status">
                                    <span class="status-indicator status-inactive"></span>
                                    <span>Microphone: Ready</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-brain me-2"></i>Recognition Status
                                </h6>
                                <div id="recognition-status">
                                    <span class="status-indicator status-inactive"></span>
                                    <span>Speech Recognition: Ready</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Configuration
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Recent Commands -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Commands
                </h5>
            </div>
            <div class="card-body history-scroll">
                <div id="command-history">
                    <p class="text-muted text-center">No commands detected yet</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let isListening = false;
let commandHistory = [];
let recognition;

function startListening() {
    if (isListening) return;
    // Ask for microphone permission first
    navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
        // Permission granted, proceed
        isListening = true;
        const button = document.getElementById('listen-btn');
        const statusText = document.getElementById('status-text');
        const instructionText = document.getElementById('instruction-text');
        const microphoneIcon = document.getElementById('microphone-icon');
        const audioStatus = document.getElementById('audio-status');
        const recognitionStatus = document.getElementById('recognition-status');

        // Update UI
        button.innerHTML = '<span class="loading-spinner me-2"></span>Listening...';
        button.disabled = true;
        statusText.textContent = 'Listening...';
        instructionText.textContent = 'Speak now!';
        microphoneIcon.innerHTML = '<i class="fas fa-microphone-slash fa-5x text-warning"></i>';
        audioStatus.innerHTML = '<span class="status-indicator status-active"></span><span>Microphone: Active</span>';
        recognitionStatus.innerHTML = '<span class="status-indicator status-active"></span><span>Speech Recognition: Processing</span>';

        // Use browser Web Speech API
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!window.SpeechRecognition) {
            statusText.textContent = 'Not Supported';
            instructionText.textContent = 'Your browser does not support speech recognition.';
            microphoneIcon.innerHTML = '<i class="fas fa-exclamation-triangle fa-5x text-danger"></i>';
            button.innerHTML = '<i class="fas fa-microphone me-2"></i>Start Listening';
            button.disabled = false;
            return;
        }
        recognition = new window.SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('transcript-content').textContent = transcript;
            let triggerWords = ['launch', 'open', 'start', 'go'];
            let found = triggerWords.some(word => transcript.toLowerCase().includes(word));
            if (found) {
                statusText.textContent = 'Command Recognized!';
                instructionText.textContent = `Heard: "${transcript}"`;
                microphoneIcon.innerHTML = '<i class="fas fa-check-circle fa-5x text-success"></i>';
                addToHistory(transcript, true);
                setTimeout(() => {
                    window.location.href = '{{ url_for("launch") }}';
                }, 1500);
            } else {
                statusText.textContent = 'Command Not Recognized';
                instructionText.textContent = 'Please try again';
                microphoneIcon.innerHTML = '<i class="fas fa-times-circle fa-5x text-danger"></i>';
                addToHistory(transcript, false);
                setTimeout(resetListening, 2000);
            }
            isListening = false;
            button.innerHTML = '<i class="fas fa-microphone me-2"></i>Start Listening';
            button.disabled = false;
        };
        recognition.onerror = function(event) {
            statusText.textContent = 'Error';
            instructionText.textContent = 'Speech recognition error. Please try again.';
            microphoneIcon.innerHTML = '<i class="fas fa-exclamation-triangle fa-5x text-danger"></i>';
            addToHistory('Error: ' + event.error, false);
            setTimeout(resetListening, 2000);
            isListening = false;
            button.innerHTML = '<i class="fas fa-microphone me-2"></i>Start Listening';
            button.disabled = false;
        };
        recognition.onend = function() {
            if (isListening) {
                // If ended without result, reset
                resetListening();
            }
        };
        recognition.start();
    }).catch(function(err) {
        // Permission denied or error
        const button = document.getElementById('listen-btn');
        const statusText = document.getElementById('status-text');
        const instructionText = document.getElementById('instruction-text');
        const microphoneIcon = document.getElementById('microphone-icon');
        statusText.textContent = 'Microphone Permission Denied';
        instructionText.textContent = 'Please allow microphone access in your browser settings.';
        microphoneIcon.innerHTML = '<i class="fas fa-exclamation-triangle fa-5x text-danger"></i>';
        button.innerHTML = '<i class="fas fa-microphone me-2"></i>Start Listening';
        button.disabled = false;
        isListening = false;
    });
}

function resetListening() {
    isListening = false;
    const button = document.getElementById('listen-btn');
    const statusText = document.getElementById('status-text');
    const instructionText = document.getElementById('instruction-text');
    const microphoneIcon = document.getElementById('microphone-icon');
    const audioStatus = document.getElementById('audio-status');
    const recognitionStatus = document.getElementById('recognition-status');
    button.innerHTML = '<i class="fas fa-microphone me-2"></i>Start Listening';
    button.disabled = false;
    statusText.textContent = 'Ready to Listen';
    instructionText.textContent = 'Click the button below or say a command to trigger the launch';
    microphoneIcon.innerHTML = '<i class="fas fa-microphone fa-5x text-primary"></i>';
    audioStatus.innerHTML = '<span class="status-indicator status-inactive"></span><span>Microphone: Ready</span>';
    recognitionStatus.innerHTML = '<span class="status-indicator status-inactive"></span><span>Speech Recognition: Ready</span>';
    if (recognition) recognition.stop();
}

function addToHistory(command, success) {
    commandHistory.unshift({
        command: command,
        success: success,
        timestamp: new Date().toLocaleTimeString()
    });
    if (commandHistory.length > 5) {
        commandHistory = commandHistory.slice(0, 5);
    }
    const historyDiv = document.getElementById('command-history');
    if (commandHistory.length === 0) {
        historyDiv.innerHTML = '<p class="text-muted text-center">No commands detected yet</p>';
    } else {
        historyDiv.innerHTML = commandHistory.map(item => `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <i class="fas fa-${item.success ? 'check-circle text-success' : 'times-circle text-danger'} me-2"></i>
                    ${item.command}
                </div>
                <small class="text-muted">${item.timestamp}</small>
            </div>
        `).join('');
    }
}
</script>
{% endblock %}
