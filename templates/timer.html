{% extends "base.html" %}

{% block title %}Timer Trigger - Activity Launch App{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        {% if not launch_time %}
        <!-- Scheduling Form -->
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                <h2 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Schedule Launch
                </h2>
            </div>
            <div class="card-body p-4">
                <form action="{{ url_for('schedule_launch') }}" method="POST">
                    <div class="mb-4">
                        <label for="launch_time" class="form-label">
                            <i class="fas fa-calendar-alt me-2"></i>Select Launch Time
                        </label>
                        <input type="datetime-local" class="form-control" id="launch_time" name="launch_time" required>
                        <div class="form-text">
                            Choose the date and time when you want to trigger the launch.
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-clock me-2"></i>Schedule Launch
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% else %}
        <!-- Countdown Display -->
        <div class="card">
            <div class="card-header bg-success text-white text-center">
                <h2 class="mb-0">
                    <i class="fas fa-hourglass-half me-2"></i>Countdown to Launch
                </h2>
            </div>
            <div class="card-body p-4 text-center">
                <div class="display-3 mb-3" id="timer-display">--:--:--</div>
                <div class="mb-2 text-muted">Scheduled for: <span id="scheduled-time">{{ launch_time }}</span></div>
                <div class="alert alert-info">Keep this page open. Launch will execute automatically.</div>
            </div>
        </div>
        {% endif %}
        
        <!-- Quick Schedule Options -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Schedule
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="setQuickTime(5)">
                            <i class="fas fa-stopwatch me-2"></i>5 Minutes
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="setQuickTime(15)">
                            <i class="fas fa-stopwatch me-2"></i>15 Minutes
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="setQuickTime(30)">
                            <i class="fas fa-stopwatch me-2"></i>30 Minutes
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="setQuickTime(60)">
                            <i class="fas fa-stopwatch me-2"></i>1 Hour
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Current Time Display -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-globe me-2"></i>Current Time
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-muted">Local Time</h6>
                        <h4 id="local-time" class="text-primary">
                            <i class="fas fa-clock me-2"></i>
                            <span id="local-time-display">--:--:--</span>
                        </h4>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Date</h6>
                        <h4 id="current-date" class="text-info">
                            <i class="fas fa-calendar me-2"></i>
                            <span id="date-display">--/--/----</span>
                        </h4>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Timezone</h6>
                        <h4 class="text-secondary">
                            <i class="fas fa-globe me-2"></i>
                            <span id="timezone-display">Local</span>
                        </h4>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Instructions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-check-circle text-success me-2"></i>What happens:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">• Launch is scheduled for the specified time</li>
                            <li class="mb-2">• Keep this page open until launch time</li>
                            <li class="mb-2">• Launch will execute automatically</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Important:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">• Don't close this browser tab</li>
                            <li class="mb-2">• Ensure stable internet connection</li>
                            <li class="mb-2">• Timer accuracy depends on system clock</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Configuration
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
{% if launch_time %}
let timerInterval;
let countdownInterval;
let launched = false;
let launchTime = new Date("{{ launch_time }}").getTime();

function startTimer(targetTime) {
    timerInterval = setInterval(function() {
        let now = new Date().getTime();
        let distance = targetTime - now;
        if (distance <= 0 && !launched) {
            clearInterval(timerInterval);
            showCountdownAndLaunch();
        } else if (!launched) {
            updateTimerDisplay(distance);
        }
    }, 500);
}

function updateTimerDisplay(distance) {
    let seconds = Math.floor((distance / 1000) % 60);
    let minutes = Math.floor((distance / (1000 * 60)) % 60);
    let hours = Math.floor((distance / (1000 * 60 * 60)) % 24);
    let days = Math.floor(distance / (1000 * 60 * 60 * 24));
    let display = '';
    if (days > 0) display += days + 'd ';
    if (hours > 0 || days > 0) display += hours + 'h ';
    if (minutes > 0 || hours > 0 || days > 0) display += minutes + 'm ';
    display += seconds + 's';
    document.getElementById('timer-display').textContent = display;
}

function showCountdownAndLaunch() {
    launched = true;
    let countdown = 3;
    document.getElementById('timer-display').textContent = countdown;
    countdownInterval = setInterval(function() {
        countdown--;
        if (countdown > 0) {
            document.getElementById('timer-display').textContent = countdown;
        } else {
            clearInterval(countdownInterval);
            document.getElementById('timer-display').textContent = 'Launching...';
            setTimeout(function() {
                window.location.href = '{{ url_for("launch") }}';
            }, 500);
        }
    }, 1000);
}

document.addEventListener('DOMContentLoaded', function() {
    startTimer(launchTime);
});
{% endif %}
</script>
{% endblock %}
